modules = ["nodejs-18"]

run = [
    "bash",
    "-c",
    """

# Function to handle .env configuration for a specific package
configure_env() {
    local package_name=$1
    local package_dir=$2
    local env_file=$3
    shift 3
    local keys=("$@")
    
    echo "=== Configuring $package_name environment variables ==="
    echo "Package directory: $package_dir"
    echo "Environment file: $env_file"
    echo
    
    # Create package directory if it doesn't exist
    mkdir -p "$package_dir"
    
    # Check if .env file exists, if not, create it with default keys
    if [ ! -f "$env_file" ]; then
        echo "Creating $env_file with necessary keys."
        for key in "${keys[@]}"; do
            echo "$key=" >> "$env_file"
        done
    else
        # Ensure all required keys exist in the file
        for key in "${keys[@]}"; do
            if ! grep -q "^$key=" "$env_file"; then
                echo "Adding missing key: $key"
                echo "$key=" >> "$env_file"
            fi
        done
    fi

    # Read existing keys from .env file
    existing_keys=($(cut -d '=' -f 1 "$env_file"))

    # Display the keys to the user
    echo "Found the following keys in $env_file:"
    for key in "${existing_keys[@]}"; do
        echo "- $key"
    done

    # Prompt the user for values for each key that doesn't already have a value
    echo
    echo "Enter values for the keys listed above (only for those without values):"
    echo
    for key in "${existing_keys[@]}"; do
        # Check if the key has a value in the .env file
        current_value=$(grep "^$key=" "$env_file" | cut -d '=' -f 2-)
        
        # If the current value is empty, prompt the user for input
        if [ -z "$current_value" ]; then
            read -p "Enter value for $key: " input
            if [ -n "$input" ]; then
                # Update the .env file with the new value
                sed -i "s|^$key=.*|$key=$input|" "$env_file"
                echo "Updated $key in $env_file."
            else
                echo "No value entered for $key, skipping."
            fi
            echo
        else
            echo "$key already has a value, skipping."
        fi 
    done
    echo
}

echo "RSK Scaffold Replit Setup"
echo "============================"
echo

# Configure Hardhat environment variables
hardhat_keys=("DEPLOYER_PRIVATE_KEY" "ROOTSTOCK_RPC_URL")
configure_env "Hardhat" "packages/hardhat" "packages/hardhat/.env" "${hardhat_keys[@]}"

# Configure NextJS environment variables  
nextjs_keys=("NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID" "NEXT_PUBLIC_ROOTSTOCK_RPC_URL")
configure_env "NextJS" "packages/nextjs" "packages/nextjs/.env" "${nextjs_keys[@]}"

echo "Environment configuration completed!"
echo

# Install root dependencies
echo "Installing root dependencies..."
yarn

# Fix hardhat-deploy jsonfile dependency issue in Replit
echo "Fixing hardhat-deploy jsonfile dependency for Replit..."
cd packages/hardhat
echo "Installing jsonfile to resolve fs-extra dependency..."
yarn add jsonfile
cd ../..
echo "jsonfile installed"

# Deploy contracts
echo "Deploying contracts..."
yarn deploy
echo

# echo "contract deployed successfully!"

# echo "Running NextJS app..."
yarn start
echo

echo "Setup completed successfully!"
# """,
]

[nix]
channel = "stable-24_05"

[agent]
expertMode = true

[[ports]]
localPort = 5000
externalPort = 80